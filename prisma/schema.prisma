// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

//////////////////////
// ENUMS
//////////////////////

enum RolUsuario {
  ADMIN
  OPERADOR
}

enum TipoBitacora {
  ACTIVIDADES_DIARIAS
  DESCARGA_PIPAS
  OPERACION_MANTENIMIENTO
}

enum TipoMantenimiento {
  PREVENTIVO
  CORRECTIVO
}

enum PeriodicidadBitacora {
  DIARIA
  POR_EVENTO
  TRIMESTRAL
  ANUAL
}

//////////////////////
// MODELOS PRINCIPALES
//////////////////////

model Usuario {
  id               Int         @id @default(autoincrement())
  nombre           String
  correo           String      @unique
  contrasenaHash   String
  rol              RolUsuario  @default(OPERADOR)
  refreshTokenHash  String?
  createdAt        DateTime    @default(now())

  estaciones       Estacion[]
  personasCreadas  PersonaAutorizada[]
  auditorias       Auditoria[]
}

model Estacion {
  id              Int      @id @default(autoincrement())
  nombre          String
  razonSocial     String
  rfc             String
  permisoCRE      String   @unique
  direccion       String
  representante   String
  telefono        String?

  adminId         Int
  createdAt       DateTime @default(now())

  admin           Usuario  @relation(fields: [adminId], references: [id])
  personas        PersonaAutorizada[]
  bitacoras       Bitacora[]
}

model PersonaAutorizada {
  id               Int      @id @default(autoincrement())
  nombre           String
  cargo            String
  firmaHashPersona String

  estacionId       Int
  creadoPorId      Int
  createdAt        DateTime @default(now())

  estacion         Estacion @relation(fields: [estacionId], references: [id])
  creadoPor        Usuario  @relation(fields: [creadoPorId], references: [id])
  registros        RegistroBitacora[]

  @@index([estacionId])
}

model Bitacora {
  id             Int                    @id @default(autoincrement())
  tipo           TipoBitacora
  estacionId     Int
  fundamento     String                 @default("NOM-005-ASEA-2016")
  createdAt      DateTime               @default(now())

  estacion       Estacion               @relation(fields: [estacionId], references: [id])
  registros      RegistroBitacora[]

  @@unique([estacionId, tipo])
  @@index([estacionId])
}

//////////////////////
// REGISTRO LEGAL (INMUTABLE)
//////////////////////

model RegistroBitacora {
  id                 Int      @id @default(autoincrement())

  folio              Int
  fechaHora          DateTime @default(now())
  descripcion        String
  periodicidad       PeriodicidadBitacora?

  // FIRMA DIGITAL
  firmaHashRegistro  String
  firmaAlgoritmo     String   @default("SHA-256")
  firmaFecha         DateTime @default(now())

  // BLOQUEO LEGAL
  cerrado            Boolean  @default(true)
  fechaCierre        DateTime @default(now())

  personaId          Int
  bitacoraId         Int
  estacionId         Int

  persona            PersonaAutorizada @relation(fields: [personaId], references: [id])
  bitacora           Bitacora           @relation(fields: [bitacoraId], references: [id])

  descargaPipa       DescargaPipa?
  mantenimiento      Mantenimiento?

  @@unique([estacionId, bitacoraId, folio])
  @@index([personaId])
}

//////////////////////
// BITÁCORAS ESPECÍFICAS
//////////////////////

model DescargaPipa {
  id               Int     @id @default(autoincrement())
  registroId       Int     @unique

  numeroPipa       String
  producto         String
  volumenRecibido  Float
  proveedor        String

  registro         RegistroBitacora @relation(fields: [registroId], references: [id])
}

model Mantenimiento {
  id             Int               @id @default(autoincrement())
  registroId     Int               @unique

  tipo           TipoMantenimiento
  actividad      String
  observaciones  String?

  registro       RegistroBitacora  @relation(fields: [registroId], references: [id])
}

//////////////////////
// AUDITORÍA (TRAZABILIDAD)
//////////////////////

model Auditoria {
  id          Int      @id @default(autoincrement())
  tabla       String
  registroId  Int
  accion      String
  fecha       DateTime @default(now())

  usuarioId   Int
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
}
